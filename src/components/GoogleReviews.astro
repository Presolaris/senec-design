---
// Google Reviews Widget - lädt Bewertungen von Google Places API
---

<section class="py-16 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <div class="inline-block bg-[var(--senec-turquoise)]/10 backdrop-blur-sm px-4 py-2 rounded-full mb-4">
        <span class="text-[var(--senec-turquoise)] text-sm font-semibold">Kundenbewertungen</span>
      </div>
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
        Was unsere Kunden sagen
      </h2>
      <div id="rating-summary" class="flex items-center justify-center gap-3 mb-2">
        <div class="flex gap-1" id="rating-stars">
          <!-- Sterne werden dynamisch eingefügt -->
        </div>
        <span class="text-2xl font-bold text-gray-900" id="rating-value">-</span>
        <span class="text-gray-600" id="rating-count">(-)</span>
      </div>
      <a href="https://www.google.com/maps/search/Leipzig+Photovoltaik" target="_blank" rel="noopener" class="text-[var(--senec-turquoise)] hover:underline text-sm">
        Bewertung auf Google abgeben
      </a>
    </div>

    <div id="reviews-container" class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
      <!-- Loading State -->
      <div class="col-span-3 text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--senec-turquoise)]"></div>
        <p class="text-gray-600 mt-4">Bewertungen werden geladen...</p>
      </div>
    </div>

    <div class="text-center mt-8">
      <a href="https://www.google.com/maps/search/Leipzig+Photovoltaik" target="_blank" rel="noopener" class="inline-flex items-center text-[var(--senec-turquoise)] font-semibold hover:underline">
        Alle Bewertungen auf Google ansehen
        <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
      </a>
    </div>
  </div>
</section>

<script>
  // Place ID für Leipzig Photovoltaik (muss angepasst werden)
  const PLACE_ID = 'ChIJAVkDPydJnkcRcAIEdFhn5iQ'; // Beispiel - muss durch echte Place ID ersetzt werden
  
  function renderStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    let starsHTML = '';
    
    for (let i = 0; i < 5; i++) {
      if (i < fullStars) {
        starsHTML += '<svg class="w-6 h-6 text-yellow-400 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';
      } else if (i === fullStars && hasHalfStar) {
        starsHTML += '<svg class="w-6 h-6 text-yellow-400" viewBox="0 0 20 20"><defs><linearGradient id="half"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="#e5e7eb"/></linearGradient></defs><path fill="url(#half)" d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';
      } else {
        starsHTML += '<svg class="w-6 h-6 text-gray-300 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>';
      }
    }
    
    return starsHTML;
  }
  
  function renderReview(review) {
    const timeAgo = review.relative_time_description || 'Kürzlich';
    const text = review.text || '';
    const truncatedText = text.length > 200 ? text.substring(0, 200) + '...' : text;
    
    return `
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
        <div class="flex items-center gap-3 mb-4">
          <img src="${review.profile_photo_url}" alt="${review.author_name}" class="w-12 h-12 rounded-full object-cover" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23cbd5e1%22%3E%3Cpath d=%22M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z%22/%3E%3C/svg%3E'">
          <div>
            <div class="font-semibold text-gray-900">${review.author_name}</div>
            <div class="flex gap-1">
              ${renderStars(review.rating)}
            </div>
          </div>
        </div>
        <p class="text-gray-600 text-sm mb-3">${truncatedText}</p>
        <div class="text-xs text-gray-500">${timeAgo}</div>
      </div>
    `;
  }
  
  async function loadReviews() {
    try {
      // Google Places API laden
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_CLOUD_API_KEY}&libraries=places`;
          script.async = true;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      // Places Service initialisieren
      const map = new google.maps.Map(document.createElement('div'));
      const service = new google.maps.places.PlacesService(map);
      
      // Place Details abrufen
      service.getDetails(
        {
          placeId: PLACE_ID,
          fields: ['name', 'rating', 'user_ratings_total', 'reviews']
        },
        (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && place) {
            // Rating Summary aktualisieren
            document.getElementById('rating-stars').innerHTML = renderStars(place.rating || 0);
            document.getElementById('rating-value').textContent = (place.rating || 0).toFixed(1);
            document.getElementById('rating-count').textContent = `(${place.user_ratings_total || 0} Bewertungen)`;
            
            // Reviews anzeigen
            const reviews = place.reviews || [];
            const container = document.getElementById('reviews-container');
            
            if (reviews.length > 0) {
              // Nur die besten 3 Bewertungen anzeigen
              const topReviews = reviews
                .sort((a, b) => b.rating - a.rating)
                .slice(0, 3);
              
              container.innerHTML = topReviews.map(review => renderReview(review)).join('');
            } else {
              container.innerHTML = `
                <div class="col-span-3 text-center py-8">
                  <p class="text-gray-600">Noch keine Bewertungen verfügbar.</p>
                </div>
              `;
            }
          } else {
            // Fallback bei Fehler
            showFallbackReviews();
          }
        }
      );
    } catch (error) {
      console.error('Fehler beim Laden der Reviews:', error);
      showFallbackReviews();
    }
  }
  
  function showFallbackReviews() {
    // Fallback: Statische Demo-Bewertungen
    const container = document.getElementById('reviews-container');
    container.innerHTML = `
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
            <span class="text-gray-600 font-semibold">MK</span>
          </div>
          <div>
            <div class="font-semibold text-gray-900">Michael K.</div>
            <div class="flex gap-1">
              ${renderStars(5)}
            </div>
          </div>
        </div>
        <p class="text-gray-600 text-sm mb-3">Sehr professionelle Beratung und Installation. Die Anlage läuft einwandfrei!</p>
        <div class="text-xs text-gray-500">vor 2 Wochen</div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
            <span class="text-gray-600 font-semibold">SM</span>
          </div>
          <div>
            <div class="font-semibold text-gray-900">Sandra M.</div>
            <div class="flex gap-1">
              ${renderStars(5)}
            </div>
          </div>
        </div>
        <p class="text-gray-600 text-sm mb-3">Kompetente Beratung, faire Preise und pünktliche Umsetzung. Sehr empfehlenswert!</p>
        <div class="text-xs text-gray-500">vor 1 Monat</div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
            <span class="text-gray-600 font-semibold">TS</span>
          </div>
          <div>
            <div class="font-semibold text-gray-900">Thomas S.</div>
            <div class="flex gap-1">
              ${renderStars(5)}
            </div>
          </div>
        </div>
        <p class="text-gray-600 text-sm mb-3">Von der Planung bis zur Inbetriebnahme alles perfekt. Danke für die tolle Arbeit!</p>
        <div class="text-xs text-gray-500">vor 3 Monaten</div>
      </div>
    `;
    
    document.getElementById('rating-stars').innerHTML = renderStars(5);
    document.getElementById('rating-value').textContent = '5.0';
    document.getElementById('rating-count').textContent = '(Demo-Bewertungen)';
  }
  
  // Reviews beim Laden der Seite abrufen
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadReviews);
  } else {
    loadReviews();
  }
</script>
